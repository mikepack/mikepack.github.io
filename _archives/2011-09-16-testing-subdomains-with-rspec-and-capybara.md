---
title: "Testing subdomains with RSpec and Capybara"
date: 2011-09-16
categories:
  - Archive
tags:
  - subdomains
  - capybara
  - testing
  - rspec
  - pow
---

There's a lot of ugly solutions out there regarding this problem and rightfully so, it's a pain in the ass. I've gone through a good number of options and found the following to be the most simple. `Warning: It only works on Mac OS X`.

## Configure Capybara

Capybara allows you to set the server port to run the test server on. This may or may not be necessary depending on your environment. It was necessary for me because <a href="http://pow.cx/" target="_blank">Pow</a> hijacks my default port.

`spec_helper.rb`

```
Capybara.server_port = 6543
```

## Use the Subdomain

Mac OS X comes with a handy *.127localhost.com domain configured for you. So you can do contact.127localhost.com, test.127localhost.com, etc and it will all point to 127.0.0.1.

When you need to use your subdomain, simply use a url helper:

`login_spec.rb`

```
describe 'as a guest user on the mobile login page' do
  before do
    visit login_url(:subdomain => 'contact', :host => '127localhost.com', :port => 6543)
  end

  it 'shows me the login form' do
    page.should have_content('Login')
  end
end
```

Note: The :subdomain option isn't available by default. I stole it from Ryan Bate's <a href="http://railscasts.com/episodes/221-subdomains-in-rails-3" target="_blank">Railscast</a> and <a href="https://gist.github.com/1222505" target="_blank">gisted it</a>.

## Other Options

Fenangling the /etc/hosts feels dirty and pollutes domain resolution.

Ultimately, it would be awesome to boot a <a href="http://pow.cx/manual.html#section_3.1" target="_blank">Pow</a> server for testing and use something like http://contact.myapp.test where the development app lives at http://contact.myapp.dev. It's possible to get Pow to boot at http://myapp.test by using the <a href="http://pow.cx/manual.html#section_3.1" target="_blank">POW_DOMAINS environment variable</a>. The issue here is the Pow server still runs in development. You can start the Pow server in an environment other than development by <a href="https://github.com/37signals/pow/wiki/FAQ" target="_blank">using .powenv</a>. The issue here is managing the .powenv file so that it only exists during testing. Also, there would be additional boot time by restarting the Pow server.

I hope that in future versions of Pow, it's possible to configure the environment based on the top-level domain such as dev or test. That way, you can modify /etc/resolver/test to point to the port for which your test app lives during runtime. The resolver files are pretty simple and could be modified to look like the following:

`/etc/resolver/test`

```
# Lovingly generated by Pow
nameserver 127.0.0.1
port 6543
```

Until Pow provides the ability to run different environments, I'll stick to *.127localhost.com.

Happy testing!

*0 comments*